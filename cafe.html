<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Capy Cafe</title>
<style>
  body, html { margin:0; padding:0; overflow:hidden; font-family:sans-serif; background: url('bg1.png') no-repeat center center; background-size: cover; }
  #client { position:absolute; top:50px; left:-500px; width:300px; transition: all 1s ease; }
  #client.show { left: 50px; opacity:1; }
  #orderBubble { position:absolute; top:-50px; left:0; width:100px; text-align:center; }
  #ingredients { position:absolute; top:10px; left:350px; display:flex; gap:20px; }
  .ingredient { width: 150px; height:150px; cursor:pointer; position:relative; }
  #cup { position:absolute; top:300px; left:500px; width:300px; height:300px; background:url('cup.png') no-repeat center center; background-size:contain; }
  #actions { position:absolute; bottom:50px; left:500px; display:flex; gap:20px; }
  button { padding:10px 20px; font-size:18px; cursor:pointer; }
  #topPanel { position:absolute; top:10px; right:10px; display:flex; gap:20px; align-items:center; font-size:20px; color:#fff; }
  #reviewsPanel { position:absolute; top:100px; left:50%; transform:translateX(-50%); width:600px; height:400px; background:#fff; border:2px solid #000; display:none; overflow-y:auto; }
  #reviewsPanel h2 { text-align:center; }
  #settings { position:absolute; top:10px; right:150px; cursor:pointer; width:50px; height:50px; }
  #achievements { position:absolute; bottom:10px; left:10px; font-size:18px; color:#fff; }
</style>
</head>
<body>

<!-- –ö–ª–∏–µ–Ω—Ç -->
<div id="client">
  <img id="clientImg" src="capy.png" width="300">
  <div id="orderBubble">üçµ</div>
  <div id="clientActions">
    <button id="acceptOrder">‚úî</button>
    <button id="declineOrder">‚úñ</button>
  </div>
</div>

<!-- –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã -->
<div id="ingredients">
  <div class="ingredient" data-name="matcha" style="background:url('matcha.png') center/contain no-repeat;"></div>
  <div class="ingredient" data-name="tea" style="background:url('tea.png') center/contain no-repeat;"></div>
  <div class="ingredient" data-name="coffee" style="background:url('coffee.png') center/contain no-repeat;"></div>
  <div class="ingredient" data-name="marshmallow" style="background:url('marshmallow.png') center/contain no-repeat;"></div>
  <div class="ingredient" data-name="milk" style="background:url('milk.png') center/contain no-repeat;"></div>
</div>

<!-- –ß–∞—à–∫–∞ -->
<div id="cup"></div>

<!-- –î–µ–π—Å—Ç–≤–∏—è -->
<div id="actions">
  <button id="undo">‚Üê</button>
  <button id="redo">‚Üí</button>
  <button id="eat">Eat</button>
  <button id="done">Done</button>
</div>

<!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
<div id="topPanel">
  <span id="money">üí∞ 0</span>
  <span id="stars">‚úÆ 1</span>
  <span id="reviewsBtn">üí¨</span>
  <img id="settings" src="settings.png">
</div>

<!-- –ü–∞–Ω–µ–ª—å –æ—Ç–∑—ã–≤–æ–≤ -->
<div id="reviewsPanel">
  <h2>Reviews</h2>
  <div id="reviewsList"></div>
  <button id="closeReviews">Close</button>
</div>

<!-- –ê—á–∏–≤–∫–∏ -->
<div id="achievements">Achievements: 0/10 clients</div>

<audio id="bgMusic" src="music4game.mp3" loop autoplay></audio>

<script>
let language = localStorage.getItem('language') || 'eng';
let money = parseInt(localStorage.getItem('money') || '0');
let starsCafe = parseInt(localStorage.getItem('starsCafe') || '1');
let reviews = JSON.parse(localStorage.getItem('reviews') || '[]');
let achievementsCount = parseInt(localStorage.getItem('achievements') || '0');

const client = document.getElementById('client');
const clientImg = document.getElementById('clientImg');
const orderBubble = document.getElementById('orderBubble');
const cup = document.getElementById('cup');
const moneySpan = document.getElementById('money');
const starsSpan = document.getElementById('stars');
const reviewsPanel = document.getElementById('reviewsPanel');
const reviewsList = document.getElementById('reviewsList');
const reviewsBtn = document.getElementById('reviewsBtn');
const eatBtn = document.getElementById('eat');
const doneBtn = document.getElementById('done');
const undoBtn = document.getElementById('undo');
const redoBtn = document.getElementById('redo');

let currentOrder = null;
let cupIngredients = [];
let history = [];
let historyRedo = [];

function saveProgress() {
  localStorage.setItem('money', money);
  localStorage.setItem('starsCafe', starsCafe);
  localStorage.setItem('reviews', JSON.stringify(reviews));
  localStorage.setItem('achievements', achievementsCount);
}

function loadReviews() {
  reviewsList.innerHTML = '';
  reviews.forEach(r => {
    const div = document.createElement('div');
    div.innerHTML = `${r.name} ${'‚úÆ'.repeat(r.stars)}<br>${r.text}`;
    reviewsList.appendChild(div);
  });
}

function generateClient() {
  // –í—ã–±–æ—Ä —Ä–∞–Ω–¥–æ–º–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
  const genders = ['boy', 'girl'];
  const gender = genders[Math.floor(Math.random()*2)];
  clientImg.src = gender==='boy'?'capy.png':'capygirl.png';
  // –†–∞–Ω–¥–æ–º–Ω—ã–π –∞–∫—Å–µ—Å—Å—É–∞—Ä
  const accessories = ['hat','dress','jacket','jewelry'];
  const chosen = accessories[Math.floor(Math.random()*accessories.length)];
  // TODO: –¥–æ–±–∞–≤–∏—Ç—å –∞–∫—Å–µ—Å—Å—É–∞—Ä –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–ª–æ–π –ø–æ–≤–µ—Ä—Ö capy (—Ç—ã –Ω–∞—Ä–∏—Å—É–µ—à—å)
  
  // –†–∞–Ω–¥–æ–º–Ω—ã–π –∑–∞–∫–∞–∑
  const options = ['matcha','tea','coffee','marshmallow','milk'];
  const order = [];
  const count = Math.floor(Math.random()*3)+1;
  while(order.length<count){
    const item = options[Math.floor(Math.random()*options.length)];
    if(!order.includes(item)) order.push(item);
  }
  currentOrder = order;
  orderBubble.innerHTML = order.map(i=>i).join(' + ');
  client.classList.add('show');
}

document.querySelectorAll('.ingredient').forEach(elem=>{
  elem.addEventListener('click',()=>{
    const ing = elem.dataset.name;
    cupIngredients.push(ing);
    cup.style.backgroundImage = `url('cup_${cupIngredients.join('_')}.png')`;
    history.push([...cupIngredients]);
    historyRedo = [];
  });
});

eatBtn.addEventListener('click',()=>{
  cupIngredients = [];
  cup.style.backgroundImage = `url('cup.png')`;
});

undoBtn.addEventListener('click',()=>{
  if(history.length>1){
    historyRedo.push(history.pop());
    cupIngredients = history[history.length-1];
    cup.style.backgroundImage = `url('cup_${cupIngredients.join('_')}.png')`;
  }
});

redoBtn.addEventListener('click',()=>{
  if(historyRedo.length>0){
    const next = historyRedo.pop();
    history.push(next);
    cupIngredients = next;
    cup.style.backgroundImage = `url('cup_'+cupIngredients.join('_')+'.png')`;
  }
});

doneBtn.addEventListener('click',()=>{
  let errors = 0;
  currentOrder.forEach(item=>{
    if(!cupIngredients.includes(item)) errors++;
  });
  cupIngredients.forEach(item=>{
    if(!currentOrder.includes(item)) errors++;
  });
  
  // –ó–≤–µ–∑–¥—ã
  let stars = 1;
  if(errors<=2) stars=5;
  else if(errors<=3) stars=4;
  else if(errors<=5) stars=3;
  else if(errors<=8) stars=2;
  else stars=1;
  
  starsCafe = Math.round((starsCafe + stars)/2); // —Å—Ä–µ–¥–Ω–µ–µ –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–æ–µ
  starsSpan.textContent = '‚úÆ'.repeat(starsCafe);
  
  // –î–µ–Ω—å–≥–∏
  let earned = 50; // –º–æ–∂–Ω–æ –ø–æ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞–º
  money += earned;
  moneySpan.textContent = `üí∞ ${money}`;
  
const generatedNames = new Set();

// –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–ª—É—á–∞–π–Ω–æ–≥–æ –∏–º–µ–Ω–∏
function generateRandomName(gender) {
    const consonants = 'bcdfghjklmnpqrstvwxyz';
    const vowels = 'aeiou';
    let name = '';
    const length = Math.floor(Math.random() * 5) + 3; // 3-7 –±—É–∫–≤
    for (let i = 0; i < length; i++) {
        name += i % 2 === 0 ? consonants[Math.floor(Math.random() * consonants.length)] : vowels[Math.floor(Math.random() * vowels.length)];
    }
    name = name.charAt(0).toUpperCase() + name.slice(1);
    if (generatedNames.has(name)) return generateRandomName(gender);
    generatedNames.add(name);
    return name;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ–∫—Å—Ç–∞ –æ—Ç–∑—ã–≤–∞ –ø–æ –æ—à–∏–±–∫–∞–º –∏ —Å–ø–µ—Ü. —Å–ª—É—á–∞—è–º
function generateReviewText(errorsList, specialType, language, drinkType, madeDrinkType) {
    if (specialType === 'reload') {
        return language === 'eng' ? 
            "The barista wasn't on the kitchen, went away without warning." : 
            "–ë–∞—Ä–∏—Å—Ç–∞ –Ω–µ –±—ã–ª–æ –Ω–∞ –∫—É—Ö–Ω–µ, –∫—É–¥–∞-—Ç–æ —É—à—ë–ª –Ω–µ –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏–≤";
    }
    if (specialType === 'emptyCup') {
        return language === 'eng' ? 
            "The order wasn't fulfilled, sent an empty cup." : 
            "–ó–∞–∫–∞–∑ –Ω–µ –≤—ã–ø–æ–ª–Ω–∏–ª–∏ –≤–æ–≤—Å–µ, –¥–∞–ª–∏ –ø—É—Å—Ç—É—é —á–∞—à–∫—É –±–µ–∑ –Ω–∞–ø–∏—Ç–∫–æ–≤. –ù–µ —Å–æ–≤–µ—Ç—É—é —Ö–æ–¥–∏—Ç—å –≤ —ç—Ç–æ –∫–∞—Ñ–µ.";
    }
    if (specialType === 'wrongDrink') {
        return language === 'eng' ? 
            `It was tasty, although I ordered ${drinkType} instead of ${madeDrinkType}.` : 
            `–ë—ã–ª–æ –≤–∫—É—Å–Ω–æ, —Ö–æ—Ç—è —è –∑–∞–∫–∞–∑—ã–≤–∞–ª${language==='ru' ? '' : 'a'} ${drinkType} –≤–º–µ—Å—Ç–æ ${madeDrinkType}`;
    }

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –¥–ª—è –∫–∞–∂–¥–æ–π –æ—à–∏–±–∫–∏
    const commentsRu = {
        "noSugar": "–ù–µ –ø–æ–ª–æ–∂–∏–ª–∏ —Å–∞—Ö–∞—Ä",
        "wrongIngredient": "–î–∞–ª–∏ –Ω–µ —Ç–æ—Ç –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç",
        "tooSlow": "–î–µ–ª–∞–ª–∏ —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ",
        "extraIngredient": "–ü–æ–ª–æ–∂–∏–ª–∏ –ª–∏—à–Ω–∏–π –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç",
        "missingIngredient": "–ù–µ –ø–æ–ª–æ–∂–∏–ª–∏ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç",
        "wrongSequence": "–°–¥–µ–ª–∞–Ω–æ –≤ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏"
    };
    const commentsEng = {
        "noSugar": "No sugar was added",
        "wrongIngredient": "Wrong ingredient given",
        "tooSlow": "Took too long to prepare",
        "extraIngredient": "Added an extra ingredient",
        "missingIngredient": "Ingredient missing",
        "wrongSequence": "Prepared in the wrong order"
    };

    let texts = errorsList.map(err => language === 'eng' ? commentsEng[err] : commentsRu[err]);
    return texts.join("; ");
}

// –ü–æ–¥—Å—á—ë—Ç –∑–≤–µ–∑–¥
function calculateStars(errorsCount, specialType) {
    if (specialType === 'reload' || specialType === 'emptyCup') return 1;
    if (specialType === 'wrongDrink') return 3;

    if (errorsCount <= 2) return 5;
    if (errorsCount === 3) return 4;
    if (errorsCount <= 5) return 3;
    if (errorsCount <= 8) return 2;
    return 1;
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–∞
function addReview({errorsList=[], specialType=null, drinkType='', madeDrinkType='', gender='male'}) {
    const name = generateRandomName(gender);
    const stars = calculateStars(errorsList.length, specialType);
    const text = generateReviewText(errorsList, specialType, language, drinkType, madeDrinkType);

    reviews.push({name, stars, text});
    saveProgress();
    loadReviews();
}

// –ü—Ä–∏–º–µ—Ä—ã –≤—ã–∑–æ–≤–∞
// addReview({errorsList: ['noSugar','tooSlow'], gender: 'female'}); // –¥–≤–µ –æ—à–∏–±–∫–∏ –¥–µ–≤–æ—á–∫–∏
// addReview({specialType: 'reload', gender: 'male'}); // –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
// addReview({specialType: 'emptyCup', gender: 'female'}); // –ø—É—Å—Ç–∞—è —á–∞—à–∫–∞
// addReview({specialType: 'wrongDrink', drinkType:'tea', madeDrinkType:'coffee', gender:'male'}); // –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –Ω–∞–ø–∏—Ç–æ–∫

  
  // –û—á–∏—Å—Ç–∫–∞
  cupIngredients = [];
  cup.style.backgroundImage = `url('cup.png')`;
  currentOrder = null;
  history = [];
  historyRedo = [];
  
  // –ù–æ–≤–∞—è –∞—á–∏–≤–∫–∞
  achievementsCount++;
  document.getElementById('achievements').textContent = `Achievements: ${achievementsCount}/10 clients`;
  
  generateClient();
});

reviewsBtn.addEventListener('click',()=>{ reviewsPanel.style.display='block'; });
document.getElementById('closeReviews').addEventListener('click',()=>{ reviewsPanel.style.display='none'; });

// –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
moneySpan.textContent = `üí∞ ${money}`;
starsSpan.textContent = '‚úÆ'.repeat(starsCafe);
loadReviews();
generateClient();
</script>
</body>
</html>
