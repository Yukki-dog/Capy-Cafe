<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Capy Caf√©</title>
<style>
  /* ============================== */
  /*  Capy Caf√© ‚Äî cafe.html (–∑–∞–≥–ª—É—à–∫–∏) */
  /*  –í–ï–†–°–ò–Ø: –ü–æ–ª–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∫–∞—Ñ–µ (–±–µ–∑ –∫—É—Ö–Ω–∏) */
  /*  –í—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è ‚Äî –∑–∞–≥–ª—É—à–∫–∏ (—Ü–≤–µ—Ç–Ω—ã–µ –±–ª–æ–∫–∏, —Ç–µ–∫—Å—Ç—ã) */
  /* ============================== */

  :root{
    --scene-w:1200px;
    --scene-h:800px;
    --accent:#c79b5c;
    --panel-bg: rgba(255,255,255,0.9);
  }
  html,body{height:100%;}
  body{
    margin:0;padding:0;display:flex;align-items:center;justify-content:center;background:#efe6d8;font-family:Inter, Arial, sans-serif;color:#222;
  }

  /* –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ü–µ–Ω–∞ */
  #scene{
    width:var(--scene-w);height:var(--scene-h);position:relative;border-radius:18px;overflow:hidden;box-shadow:0 12px 40px rgba(0,0,0,0.15);background:linear-gradient(180deg,#fffaf5 0%, #fff1e6 100%);
  }

  /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å: –¥–µ–Ω—å–≥–∏, –∑–≤–µ–∑–¥—ã, –∫–Ω–æ–ø–∫–∏ */
  header{position:absolute;left:24px;right:24px;top:14px;display:flex;justify-content:space-between;align-items:center;pointer-events:none}
  .left-hud,.right-hud{display:flex;gap:12px;align-items:center;pointer-events:auto}
  .hud-box{background:var(--panel-bg);padding:8px 12px;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,0.06);display:flex;align-items:center;gap:10px}
  .digits{display:flex;gap:4px;align-items:center}
  .digit{width:28px;height:38px;background:#f6e7cf;border-radius:6px;display:flex;align-items:center;justify-content:center;font-weight:700}
  .hud-label{font-size:14px;color:#6b4f33}

  /* –ò–∫–æ–Ω–∫–∏ —Å–ø—Ä–∞–≤–∞ */
  .icon-btn{width:52px;height:52px;border-radius:10px;background:var(--panel-bg);display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 8px 20px rgba(0,0,0,0.06)}
  .icon-btn img{width:28px;height:28px}

  /* –ö–ª–∏–µ–Ω—Ç (—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è —á–∞—Å—Ç—å —Å–ø—Ä–∞–≤–∞ –æ—Ç –¥–≤–µ—Ä–∏) */
  .room{position:absolute;left:24px;right:24px;top:80px;bottom:120px;display:flex;align-items:flex-end;justify-content:flex-start;padding:18px}
  .door-slot{width:360px;display:flex;flex-direction:column;align-items:center;justify-content:flex-end}
  .door{width:120px;height:180px;border-radius:12px;background:linear-gradient(180deg,#d9b48a,#cea06b);display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 8px 30px rgba(0,0,0,0.12)}
  .door.disabled{opacity:0.6}
  .client-area{flex:1;display:flex;align-items:end;justify-content:flex-start;padding-left:40px}
  .client-card{width:140px;height:180px;border-radius:12px;background:#fff6ee;border:3px dashed rgba(0,0,0,0.06);display:flex;align-items:center;justify-content:center;font-size:48px;color:#c07a3b;transform:translateX(-400px);opacity:0}
  .client-card.arrive{animation:client-in 1s forwards}
  .client-card.leave{animation:client-out 0.8s forwards}
  @keyframes client-in{from{transform:translateX(-420px);opacity:0}to{transform:translateX(0);opacity:1}}
  @keyframes client-out{from{transform:translateX(0);opacity:1}to{transform:translateX(-420px);opacity:0}}

  /* –û–±–ª–∞—á–∫–æ –∑–∞–∫–∞–∑–∞ (—Ç–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∞–ø–∏—Ç–∫–∞) */
  .order-bubble{position:absolute;top:40%;left:50%;transform:translateX(-50%);min-width:220px;padding:12px 18px;border-radius:30px;background:var(--panel-bg);box-shadow:0 12px 30px rgba(0,0,0,0.08);text-align:center;font-weight:700;color:#6b4f33}

  /* –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å: –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏–Ω—è—Ç–∏—è/–æ—Ç–∫–∞–∑–∞ –∏ –ø–æ–¥—Å–∫–∞–∑–∫–∏ */
  footer{position:absolute;left:24px;right:24px;bottom:18px;display:flex;justify-content:space-between;align-items:center}
  .decision{display:flex;gap:18px}
  .big-btn{width:86px;height:86px;border-radius:16px;background:#fff;border:2px solid rgba(0,0,0,0.04);display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 12px 30px rgba(0,0,0,0.08);transition:transform .12s ease, box-shadow .12s ease}
.big-btn:active{transform:scale(0.96)}
.pulse{animation:pulse 0.9s ease}
@keyframes pulse{0%{transform:scale(1)}40%{transform:scale(1.06)}100%{transform:scale(1)}}
  .big-btn img{width:48px;height:48px}

  .status-note{background:var(--panel-bg);padding:10px 14px;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,0.06)}

  /* –ú–æ–¥–∞–ª–∫–∏ */
  .overlay{position:absolute;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center}
  .overlay.show{display:flex}
  .modal{width:820px;max-height:80%;background:url('comment.png') center/cover no-repeat;border-radius:18px;padding:26px;overflow:auto}
  #settingsModal{position:fixed;top:50%;left:50%;transform:translate(-50%,-60%);width:800px;padding:40px;border-radius:20px;box-shadow:0 0 20px rgba(0,0,0,0.3);background:url('bg1.png') no-repeat center center;background-size:cover;opacity:0;pointer-events:none;transition:all 0.4s ease;z-index:100}
  #settingsModal.show{opacity:1;transform:translate(-50%,-50%);pointer-events:auto}
  #overlay.show{display:flex;opacity:1}
  #loadingModal{position:fixed;top:0;left:0;width:100%;height:100%;display:flex;justify-content:center;align-items:center;background:rgba(0,0,0,0.5);opacity:0;pointer-events:none;transition:opacity 0.3s ease;z-index:200}
  #loadingModal.show{opacity:1;pointer-events:auto}
  #loadingModal img{max-width:80%;max-height:80%} 
  .review-item{background:rgba(255,255,255,0.95);border-radius:12px;padding:12px;margin-bottom:12px;box-shadow:0 8px 20px rgba(0,0,0,0.06)}
  .review-name{font-weight:700}
  .review-text{margin-top:8px;line-height:1.35}

  /* –ê—á–∏–≤–∫–∏ */
  .achive-panel{position:absolute;right:24px;top:120px;width:220px;background:var(--panel-bg);border-radius:12px;padding:12px;box-shadow:0 8px 20px rgba(0,0,0,0.06);display:none;opacity:0;transform:translateY(-8px);transition:opacity .25s ease, transform .25s ease;} .achive-panel.show{display:block;opacity:1;transform:translateY(0);} 
  .ach-item{display:flex;align-items:center;gap:10px;padding:8px;border-radius:10px;margin-bottom:8px;background:#fff}

  /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤–æ–º –æ—Ç–∑—ã–≤–µ */
  .msg-note{position:absolute;top:-140px;left:50%;transform:translateX(-50%);width:520px;height:120px;border-radius:14px;background:rgba(255,255,255,0.98);display:flex;align-items:center;justify-content:center;box-shadow:0 18px 40px rgba(0,0,0,0.12);cursor:pointer;transition:transform .6s ease}
  .msg-note.show{transform:translate(-50%,140px)}

  /* –ü–æ–¥–ø–∏—Å–∏ –∏ –º–µ–ª–æ—á—å */
  .muted{color:#7a6b5a;font-size:13px}
  .big{font-size:18px;font-weight:700;color:#3c2b1a}

  /* –∞–¥–∞–ø—Ç–∏–≤ / –º–µ–ª–∫–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã */
  @media(max-width:1240px){:root{--scene-w:1000px;--scene-h:700px}}
</style>
</head>
<body>

<div id="scene" role="application" aria-label="Capy Caf√© ‚Äî –∫–∞—Ñ–µ">
  <header>
    <div class="left-hud">
      <div class="hud-box">
        <div class="hud-label" id="potentialLabel">–ó–∞—Ä–∞–±–æ—Ç–æ–∫</div>
        <div id="potentialDigits" class="digits"><div class="digit">0</div></div>
      </div>
    </div>

    <div class="right-hud">
      <div class="hud-box">
        <div class="hud-label" id="balanceLabel">–ë–∞–ª–∞–Ω—Å</div>
        <div id="balanceDigits" class="digits"><div class="digit">0</div></div>
      </div>

      <div class="hud-box">
        <div class="hud-label" id="ratingLabel">–†–µ–π—Ç–∏–Ω–≥</div>
        <div id="starsDisplay" class="big">1.0 ‚úÆ</div>
      </div>

      <div class="icon-btn" id="achBtn" title="–ê—á–∏–≤–∫–∏" aria-label="–ê—á–∏–≤–∫–∏" role="button">üèÜ</div>
      <div class="icon-btn" id="reviewsBtn" title="–û—Ç–∑—ã–≤—ã" aria-label="–û—Ç–∑—ã–≤—ã" role="button">üí¨</div>
      <div class="icon-btn" id="settingsBtn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏" role="button"><img src="SettingsEng.png" alt="Settings" style="width:28px;height:28px"></div>
    </div>
  </header>

  <div class="room">
    <div class="door-slot">
      <div id="door" class="door" title="–ö—É—Ö–Ω—è ‚Äî –ø–µ—Ä–µ–π—Ç–∏" role="button">–î–í–ï–†–¨</div>
      <div style="margin-top:8px;" class="muted">–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ –∫—É—Ö–Ω—é</div>
    </div>

    <div class="client-area">
      <!-- –ö–ª–∏–µ–Ω—Ç ‚Äî –∑–∞–≥–ª—É—à–∫–∞: –æ–¥–∏–Ω –±–ª–æ–∫ —Å –±—É–∫–≤–æ–π "–ö" -->
      <div id="clientCard" class="client-card" aria-live="polite">–ö</div>
    </div>
  </div>

  <!-- –û–±–ª–∞—á–∫–æ –∑–∞–∫–∞–∑–∞ ‚Äî —Ç–æ–ª—å–∫–æ –æ–±—â–µ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∞–ø–∏—Ç–∫–∞ -->
  <div id="orderBubble" class="order-bubble">‚Äî</div>

  <footer>
    <div class="decision">
      <div id="acceptBtn" class="big-btn" title="–ü—Ä–∏–Ω—è—Ç—å –∑–∞–∫–∞–∑" role="button">‚úÖ</div>
      <div id="declineBtn" class="big-btn" title="–û—Ç–∫–ª–æ–Ω–∏—Ç—å" role="button">‚ùå</div>
    </div>

    
  </footer>

  <!-- —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤–æ–º –æ—Ç–∑—ã–≤–µ -->
  <div id="msgNote" class="msg-note">–£ –≤–∞—Å –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Äî –æ—Ç–∑—ã–≤ (–∫–ª–∏–∫, —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å)</div>

  <!-- –ø–∞–Ω–µ–ª—å –∞—á–∏–≤–æ–∫ -->
  <aside class="achive-panel" aria-hidden="false">
    <div class="big">–ê—á–∏–≤–∫–∏</div>
    <div id="achList">
      <!-- –Ω–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
    </div>
  </aside>

  <!-- –º–æ–¥–∞–ª–∫–∏ -->
  <div id="overlay" class="overlay" role="dialog" aria-hidden="true">
    <div id="reviewsModal" class="modal" role="document" aria-label="–û—Ç–∑—ã–≤—ã" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <div class="big">–û—Ç–∑—ã–≤—ã</div>
        <button id="closeReviews" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
      </div>
      <div id="reviewsList"></div>
    </div>

    <div id="achModal" class="modal" role="document" aria-label="–ê—á–∏–≤–∫–∏" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <div class="big">–ê—á–∏–≤–∫–∏</div>
        <button id="closeAch" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
      </div>
      <div id="achModalList"></div>
    </div>

    <div id="settingsModal" class="modal" role="document" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏" style="display:none">
      <div class="slider-container">
        <label id="musicLabel" for="musicSlider">Music</label>
        <input type="range" id="musicSlider" min="0" max="100">
      </div>
      <div class="slider-container">
        <label id="soundLabel" for="soundSlider">Sound</label>
        <input type="range" id="soundSlider" min="0" max="100">
      </div>
      <div style="display:flex; justify-content:center; margin-top:20px; gap:12px;">
        <button id="fullscreenBtn"><img src="FullscreenEng.png" alt="Fullscreen" style="width:48px;height:48px"></button>
        <button id="languageBtn"><img src="LanguageEng.png" alt="Language" style="width:48px;height:48px"></button>
      </div>
      <div style="text-align:center; margin-top:12px;">
        <button id="closeSettings">Close</button>
      </div>
    </div>
      </div>
    </div>
  </div>

  <!-- —Å–∫—Ä—ã—Ç–æ–µ –∞—É–¥–∏–æ -->
  <audio id="clickSound" src="click.wav"></audio>
  <audio id="closeSound" src="close.wav"></audio>
  <audio id="koverSound" src="kover.wav"></audio>
  <audio id="sh1Sound" src="sh1.wav"></audio>
  <audio id="loadingSound" src="loading.wav"></audio>
  <audio id="musicAudio" src="music4game.mp3" loop></audio> 
  
</div>

<script>
/* ==========================================================
   –ü–æ–ª–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª cafe.html (–∑–∞–≥–ª—É—à–∫–∏ –≤–∏–∑—É–∞–ª–æ–≤)
   - –ö–ª–∏–µ–Ω—Ç—ã (1 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ)
   - –ü—Ä–∏–Ω—è—Ç—å / –æ—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞–∫–∞–∑
   - –û—Ç–∑—ã–≤—ã (localStorage)
   - –ê—á–∏–≤–∫–∏ (progress –≤ localStorage)
   - –ú—É–∑—ã–∫–∞/–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å index.html —á–µ—Ä–µ–∑ localStorage)
   - –î–≤–µ—Ä—å ‚Äî –≤—Å–µ–≥–¥–∞ –≤–µ–¥—ë—Ç –Ω–∞ kitchen.html
   - –í—Å–µ –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã ‚Äî –∑–∞–≥–ª—É—à–∫–∏
   ========================================================== */

// ---- LocalStorage defaults ----
if(localStorage.musicVolume===undefined) localStorage.musicVolume=85;
if(localStorage.soundVolume===undefined) localStorage.soundVolume=100;
if(localStorage.language===undefined) localStorage.language='eng';
if(localStorage.balance===undefined) localStorage.balance=0;
if(localStorage.reviews===undefined) localStorage.reviews = JSON.stringify([]);
if(localStorage.usedNames===undefined) localStorage.usedNames = JSON.stringify([]);
if(localStorage.ach===undefined) localStorage.ach = JSON.stringify({"first_step":0,"five_stars":0,"ten_clients":0,"hundred_clients":0});
if(localStorage.clientsServed===undefined) localStorage.clientsServed = 0;
if(localStorage.hasNewReview===undefined) localStorage.hasNewReview='false';

// ---- DOM ----
const clientCard = document.getElementById('clientCard');
const orderBubble = document.getElementById('orderBubble');
const acceptBtn = document.getElementById('acceptBtn');
const declineBtn = document.getElementById('declineBtn');
const door = document.getElementById('door');
const msgNote = document.getElementById('msgNote');
const reviewsBtn = document.getElementById('reviewsBtn');
const achBtn = document.getElementById('achBtn');
const settingsBtn = document.getElementById('settingsBtn');
const overlay = document.getElementById('overlay');
const reviewsModal = document.getElementById('reviewsModal');
const reviewsList = document.getElementById('reviewsList');
const closeReviews = document.getElementById('closeReviews');
const achModal = document.getElementById('achModal');
const achModalList = document.getElementById('achModalList');
const closeAch = document.getElementById('closeAch');
const achList = document.getElementById('achList');
const settingsModal = document.getElementById('settingsModal');
const closeSettings = document.getElementById('closeSettings');
const musicAudio = document.getElementById('musicAudio');
const clickSound = document.getElementById('clickSound');
const closeSound = document.getElementById('closeSound');
const koverSound = document.getElementById('koverSound');
const sh1Sound = document.getElementById('sh1Sound');
const loadingSound = document.getElementById('loadingSound'); 
const musicSlider = document.getElementById('musicSlider');
const soundSlider = document.getElementById('soundSlider');
const fullscreenBtn = document.getElementById('fullscreenBtn');
const languageBtn = document.getElementById('languageBtn');
const potentialDigits = document.getElementById('potentialDigits');
const balanceDigits = document.getElementById('balanceDigits');
const starsDisplay = document.getElementById('starsDisplay');
const msgNoteEl = document.getElementById('msgNote');

// ---- State ----
let currentClient = null; // {name, product, potential}
// init UI sound volumes for interface sounds
[clickSound, closeSound, koverSound, sh1Sound].forEach(s=>{ if(s) s.volume = localStorage.soundVolume/100; }); 
let canAccept = true;
let awaitingKitchenReturn = false; // cafe waits for kitchen result (kitchen will push review)

// ---- Utilities ----
function saveBalance(v){ localStorage.balance = Number(v); renderBalance(); }
function addBalance(delta){ localStorage.balance = Number(localStorage.balance) + Number(delta); renderBalance(); animateBalancePulse(); }
function animateBalancePulse(){ const el = balanceDigits; if(!el) return; el.classList.add('pulse'); setTimeout(()=>el.classList.remove('pulse'),900); }
function getReviews(){ try{return JSON.parse(localStorage.reviews||'[]')}catch(e){return []} }
function setReviews(arr){ localStorage.reviews = JSON.stringify(arr); }
function getAch(){ try{return JSON.parse(localStorage.ach||'{}')}catch(e){return {}} }
function setAch(obj){ localStorage.ach = JSON.stringify(obj); renderAchList(); }
function uniqueName(){ const used = new Set(JSON.parse(localStorage.usedNames||'[]')); const syll = ['–ª–∞','–ª—É','–ª–∏','–ª–µ','–ª–æ','–¥–∞','–¥–æ','–¥–∏','–¥—É','—Ä–∞','—Ä–æ','—Ä–∏','—Ä—É','–Ω–∞','–Ω–æ','–Ω—É','–Ω—è','—Ç–∞','—Ç–æ','—Ç—É','—Ç—è','–∫–∞','–∫–æ','–∫—É','–∫–∏','—á–∞','—á—É','—à–∏','—à–∞']; let tries=0; let name=''; do{ const len = 2 + Math.floor(Math.random()*3); name = Array.from({length:len},()=> syll[Math.floor(Math.random()*syll.length)]).join(''); name = name.charAt(0).toUpperCase()+name.slice(1); tries++; if(tries>2000) break; }while(used.has(name)); used.add(name); localStorage.usedNames = JSON.stringify([...used]); return name; }

function formatDigits(container, value){ container.innerHTML=''; const s = String(value); for(const ch of s){ const d = document.createElement('div'); d.className='digit'; d.textContent = ch; container.appendChild(d); } }

// ---- Render HUD ----

// ---- i18n / Language support ----
const TEXTS = {
  ru: {
    potential: '–ó–∞—Ä–∞–±–æ—Ç–æ–∫', balance: '–ë–∞–ª–∞–Ω—Å', rating: '–†–µ–π—Ç–∏–Ω–≥',
    reviewsTitle: '–û—Ç–∑—ã–≤—ã', achTitle: '–ê—á–∏–≤–∫–∏', settingsTitle: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏',
    musicLabel: '–ú—É–∑—ã–∫–∞', soundLabel: '–ó–≤—É–∫ (—Ä–µ–∑–µ—Ä–≤)', fullscreen: 'Fullscreen', language: '–Ø–∑—ã–∫', close: '–ó–∞–∫—Ä—ã—Ç—å',
    msgNew: '–£ –≤–∞—Å –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Äî –æ—Ç–∑—ã–≤ (–∫–ª–∏–∫, —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å)',
    doorHint: '–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ –∫—É—Ö–Ω—é', accept: '–ü—Ä–∏–Ω—è—Ç—å', decline: '–û—Ç–∫–ª–æ–Ω–∏—Ç—å'
  },
  eng: {
    potential: 'Potential', balance: 'Balance', rating: 'Rating',
    reviewsTitle: 'Reviews', achTitle: 'Achievements', settingsTitle: 'Settings',
    musicLabel: 'Music', soundLabel: 'Sound (misc)', fullscreen: 'Fullscreen', language: 'Language', close: 'Close',
    msgNew: 'You have a new message ‚Äî review (click to view)',
    doorHint: 'Go to kitchen', accept: 'Accept', decline: 'Decline'
  }
};

function updateLanguageUI(){ const L = localStorage.language || 'eng';
  const t = TEXTS[L] || TEXTS.eng;
  const potentialLabel = document.getElementById('potentialLabel'); if(potentialLabel) potentialLabel.textContent = t.potential;
  const balanceLabel = document.getElementById('balanceLabel'); if(balanceLabel) balanceLabel.textContent = t.balance;
  const ratingLabel = document.getElementById('ratingLabel'); if(ratingLabel) ratingLabel.textContent = t.rating;
  const revBig = document.querySelector('#reviewsModal .big'); if(revBig) revBig.textContent = t.reviewsTitle;
  const achBig = document.querySelector('#achModal .big'); if(achBig) achBig.textContent = t.achTitle;
  const msg = document.getElementById('msgNote'); if(msg) msg.textContent = t.msgNew;
  // settings labels
  const labels = settingsModal.querySelectorAll('label'); if(labels[0]) labels[0].firstChild.nodeValue = t.musicLabel + ' ';
  if(labels[1]) labels[1].firstChild.nodeValue = t.soundLabel + ' ';

  // swap images for settings/fullscreen/language like in index.html
  const settingsBtnImg = document.querySelector('#settingsBtn img');
  const fullscreenBtnImg = document.querySelector('#fullscreenBtn img');
  const languageBtnImg = document.querySelector('#languageBtn img');
  if(L==='eng'){
    if(settingsBtnImg) settingsBtnImg.src = 'SettingsEng.png';
    if(fullscreenBtnImg) fullscreenBtnImg.src = 'FullscreenEng.png';
    if(languageBtnImg) languageBtnImg.src = 'LanguageEng.png';
  } else {
    if(settingsBtnImg) settingsBtnImg.src = 'SettingsRu.png';
    if(fullscreenBtnImg) fullscreenBtnImg.src = 'FullscreenRu.png';
    if(languageBtnImg) languageBtnImg.src = 'LanguageRu.png';
  }
}

// call once
updateLanguageUI();


function renderBalance(){ formatDigits(balanceDigits, localStorage.balance||0); }
function renderPotential(v){ formatDigits(potentialDigits, v||0); }
function renderStars(){ const revs = getReviews(); if(revs.length===0){ starsDisplay.textContent = '1.0 ‚úÆ'; return; } const avg = (revs.reduce((s,r)=>s+(r.stars||0),0)/revs.length); starsDisplay.textContent = avg.toFixed(2)+' ‚úÆ'; }

// ---- Spawn client ----

// small helper animations
function fadeInElement(el,duration=350){ if(!el) return; el.style.transition = `opacity ${duration}ms ease, transform ${duration}ms ease`; el.style.opacity = '1'; }


const PRODUCTS = ['matcha','tea','coffee','donut'];
function rollOrder(){ const kind = PRODUCTS[Math.floor(Math.random()*PRODUCTS.length)]; // potential for 5‚òÖ
  const potentials = {matcha:130, tea:50, coffee:100, donut:80};
  return {product:kind, potential:potentials[kind]||20}; }

function spawnClient(){ if(currentClient) return; // only one
  const name = uniqueName(); const order = rollOrder(); currentClient = {name, order}; canAccept = true; awaitingKitchenReturn=false;
  clientCard.classList.remove('leave'); clientCard.classList.add('arrive'); clientCard.textContent = '–ö'; clientCard.setAttribute('title', name);
  orderBubble.textContent = order.product.toUpperCase(); renderPotential(order.potential);
}

function clientLeave(afterMs=800){ if(!currentClient) return; clientCard.classList.remove('arrive'); clientCard.classList.add('leave'); currentClient = null; orderBubble.textContent='‚Äî'; renderPotential(0); setTimeout(()=>{ setTimeout(spawnClient,5000); }, afterMs); }

// ---- Review logic (cafe-side) ----
function addReview(review){ const arr=getReviews(); arr.unshift(review); setReviews(arr); renderStars(); localStorage.hasNewReview='true'; showMsgNote(); }

function showMsgNote(){ msgNoteEl.classList.add('show'); msgNoteEl.onclick = ()=>{ openReviews(); msgNoteEl.classList.remove('show'); localStorage.hasNewReview='false'; }; // auto hide after 10s
  setTimeout(()=>{ msgNoteEl.classList.remove('show'); localStorage.hasNewReview='false'; },10000);
}

// ---- Accept / Decline handlers ----
acceptBtn.addEventListener('click', ()=>{
  if(!currentClient || !canAccept) return;
  // mark order accepted ‚Äî full processing happens in kitchen.html
  canAccept = false; awaitingKitchenReturn = true; // cafe waits for kitchen result
  // save current order to localStorage for kitchen to pick up
  localStorage.currentOrder = JSON.stringify({client:currentClient.name, product:currentClient.order.product, potential:currentClient.order.potential, timestamp:Date.now()});
  // visual feedback
  acceptBtn.style.opacity = '0.6';
  // door is always active, but show small note
  // we don't remove client ‚Äî client stays until kitchen returns or player comes back.
});

declineBtn.addEventListener('click', ()=>{
  if(!currentClient) return;
  // immediate 1‚òÖ review
  addReview({name:currentClient.name, stars:1, text:getDeclineText()});
  // count served++
  localStorage.clientsServed = Number(localStorage.clientsServed||0)+1;
  checkAchievementsOnDecline();
  // client leaves
  clientLeave();
});

function getDeclineText(){ return (localStorage.language==='ru')? '–ù–µ –ø—Ä–∏–Ω—è–ª–∏ –∑–∞–∫–∞–∑.' : 'Order was declined.'; }

// ---- Door (always clickable) ----
door.addEventListener('click', ()=>{
  // navigate to kitchen; kitchen will be implemented separately
  // save current order if any
  if(currentClient && canAccept){ // if order not accepted, still you can go
    localStorage.currentOrder = JSON.stringify({client:currentClient.name, product:currentClient.order.product, potential:currentClient.order.potential, timestamp:Date.now()});
  }
  window.location.href = 'kitchen.html';
});

// ---- Reviews modal ----
function openReviews(){ overlay.classList.add('show'); reviewsModal.style.display='block'; achModal.style.display='none'; settingsModal.style.display='none'; renderReviews(); }
function closeAllModals(){ overlay.classList.remove('show'); reviewsModal.style.display='none'; achModal.style.display='none'; settingsModal.style.display='none'; }

reviewsBtn.addEventListener('click', openReviews);
closeReviews.addEventListener('click', closeAllModals);

// ---- Achievements ----
function renderAchList(){ const ach = getAch(); achList.innerHTML=''; const defs = [ ['–ü–µ—Ä–≤—ã–π —à–∞–≥','first_step','–í—ã–ø–æ–ª–Ω–∏—Ç—å –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑, +50$'], ['5 –∑–≤—ë–∑–¥–æ—á–µ–∫!','five_stars','–ü–æ–ª—É—á–∏—Ç—å –∏–¥–µ–∞–ª—å–Ω—ã–π –æ—Ç–∑—ã–≤ (5‚úÆ), +100$'], ['10 –∫–ª–∏–µ–Ω—Ç–æ–≤','ten_clients','–û–±—Å–ª—É–∂–∏—Ç—å 10 –∫–ª–∏–µ–Ω—Ç–æ–≤, +200$'], ['100 –∫–ª–∏–µ–Ω—Ç–æ–≤','hundred_clients','–û–±—Å–ª—É–∂–∏—Ç—å 100 –∫–ª–∏–µ–Ω—Ç–æ–≤, +2000$'] ]; for(const [title,key,desc] of defs){ const item = document.createElement('div'); item.className='ach-item'; item.innerHTML = `<div style="width:40px;height:40px;border-radius:8px;background:#fdebd0;display:flex;align-items:center;justify-content:center">üèÖ</div><div><div style="font-weight:700">${title}</div><div class="muted">${desc}</div><div class="muted">–ü—Ä–æ–≥—Ä–µ—Å—Å: ${ach[key]||0}</div></div>`; achList.appendChild(item); }
}

achBtn.addEventListener('click', ()=>{ overlay.classList.add('show'); achModal.style.display='block'; reviewsModal.style.display='none'; settingsModal.style.display='none'; renderAchModal(); });
closeAch.addEventListener('click', closeAllModals);

function renderAchModal(){ achModalList.innerHTML=''; const ach = getAch(); for(const k in ach){ const row = document.createElement('div'); row.className='review-item'; row.innerHTML = `<div style="font-weight:700">${k}</div><div class="muted">–ü—Ä–æ–≥—Ä–µ—Å—Å: ${ach[k]}</div>`; achModalList.appendChild(row); } }

function awardAchievement(key){ const ach = getAch(); if(!ach[key]) ach[key]=0; ach[key] = (ach[key]||0) + 1; setAch(ach); // popup
  showAchPopup(key); }

function showAchPopup(key){ const popup = document.createElement('div'); popup.className='review-item'; popup.style.position='fixed'; popup.style.left='50%'; popup.style.top='20%'; popup.style.transform='translateX(-50%)'; popup.style.zIndex=9999; popup.style.padding='14px 18px'; popup.innerHTML = `<strong>–ê—á–∏–≤–∫–∞:</strong> ${key}`; document.body.appendChild(popup); setTimeout(()=>popup.remove(),3000); }

// ---- Check achievements triggers (cafe-side) ----
function checkAchievementsOnAccept(){ // when accepted, we can increment first_step progress later maybe when kitchen returns
}
function checkAchievementsOnDecline(){ // track consecutive declines? simple increment for demonstration
  const ach = getAch(); ach['ten_clients'] = (ach['ten_clients']||0) + 0; setAch(ach);
}

// ---- Reviews rendering ----
function renderReviews(){ reviewsList.innerHTML=''; const arr = getReviews(); if(arr.length===0){ reviewsList.innerHTML='<div class="muted">–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤</div>'; return; } for(const r of arr){ const it = document.createElement('div'); it.className='review-item'; it.innerHTML = `<div class="review-name">${r.name} ${'‚úÆ'.repeat(r.stars||1)}${'‚ú´'.repeat(5-(r.stars||1))}</div><div class="review-text">${r.text}</div>`; reviewsList.appendChild(it); } }

// ---- Settings modal ----
settingsBtn.addEventListener('click', ()=>{ clickSound && clickSound.play(); settingsModal.classList.add('show'); overlay.classList.add('show'); reviewsModal.style.display='none'; achModal.style.display='none'; musicSlider.value = localStorage.musicVolume; soundSlider.value = localStorage.soundVolume; });
closeSettings.addEventListener('click', ()=>{ closeSound && closeSound.play(); settingsModal.classList.remove('show'); overlay.classList.remove('show'); });

musicSlider.addEventListener('input', ()=>{ localStorage.musicVolume = musicSlider.value; musicAudio.volume = musicSlider.value/100; koverSound && (koverSound.volume = soundSlider.value/100); koverSound && koverSound.play(); });
soundSlider.addEventListener('input', ()=>{ localStorage.soundVolume = soundSlider.value; [clickSound, closeSound, koverSound, sh1Sound].forEach(s=>{ if(s) s.volume = soundSlider.value/100; }); koverSound && koverSound.play(); });
fullscreenBtn.addEventListener('click', ()=>{ if(!document.fullscreenElement){ document.documentElement.requestFullscreen(); localStorage.fullscreen = true; } else { document.exitFullscreen(); localStorage.fullscreen = false; } });
languageBtn.addEventListener('click', ()=>{ localStorage.language = (localStorage.language==='ru')? 'eng':'ru'; updateLanguageUI(); });

// ---- Init / Boot ----
function boot(){ renderBalance(); renderStars(); renderAchList(); spawnClient(); // if returned from kitchen with review flag, show message
  if(localStorage.hasNewReview==='true'){ showMsgNote(); localStorage.hasNewReview='false'; }
  // music
  musicAudio.volume = localStorage.musicVolume/100; musicAudio.play().catch(()=>{ document.body.addEventListener('click', ()=>musicAudio.play(), {once:true}); });
  // initialize settings sliders
  musicSlider.value = localStorage.musicVolume; soundSlider.value = localStorage.soundVolume; updateLanguageUI();
}

// ---- Cross-tab sync (if settings changed on index.html or another tab) ----
window.addEventListener('storage', (e)=>{
  try{
    if(e.key==='musicVolume'){ musicSlider.value = e.newValue; musicAudio.volume = e.newValue/100; }
    if(e.key==='soundVolume'){ soundSlider.value = e.newValue; }
    if(e.key==='language'){ updateLanguageUI(); }
    if(e.key==='balance'){ renderBalance(); }
  }catch(err){/* ignore for unavailable nodes */}
});

boot();

// ---- Expose some helpers for kitchen to call when done (external contract) ----
// kitchen.html can call: window.opener.addReviewFromKitchen(...) if opened as popup, or simply set localStorage.reviews
// We'll also expose a global function to simulate kitchen returning with a review (useful for testing)
window.addReviewFromKitchen = function(name, stars, text, moneyEarned){
  // Adjust money by cafe rating multiplier (based on current average BEFORE adding this review)
  const reviewsBefore = getReviews();
  const avg = reviewsBefore.length ? (reviewsBefore.reduce((s,r)=>s+(r.stars||0),0)/reviewsBefore.length) : 1;
  function moneyMultiplier(avgStars){ if(avgStars<=1) return 0.8; if(avgStars<=2) return 0.9; if(avgStars<=3) return 1.0; if(avgStars<=4) return 1.1; return 1.25; }
  const mult = moneyMultiplier(avg);
  addReview({name, stars, text});
  if(moneyEarned){ const adjusted = Math.round(moneyEarned * mult); addBalance(adjusted); }
  localStorage.clientsServed = Number(localStorage.clientsServed||0)+1;
  if(stars===5){ awardAchievement('five_stars'); addBalance(100); }
  if(localStorage.clientsServed==1) { awardAchievement('first_step'); addBalance(50); }
  if(Number(localStorage.clientsServed)%10===0) awardAchievement('ten_clients');
  if(Number(localStorage.clientsServed)%100===0) awardAchievement('hundred_clients');
  clientLeave(400);
};

// allow testing via console: window.addReviewFromKitchen('–ò–º—è',5,'–û—Ç–ª–∏—á–Ω–æ',130)

</script>
</body>
</html>
